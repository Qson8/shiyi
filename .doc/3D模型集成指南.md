# 3D模型集成指南 - 使用hanfu-test.glb

## 一、模型文件信息

### 模型文件
- **文件名**：hanfu-test.glb
- **位置**：`.source/hanfu-test.glb`
- **格式**：GLB（glTF Binary）
- **用途**：3D展示功能测试模型

---

## 二、集成步骤

### 步骤1：创建assets目录结构

在Flutter项目中创建assets目录：

```bash
cd shi_yi
mkdir -p assets/models
```

### 步骤2：复制模型文件

将模型文件复制到assets目录：

```bash
# 从.source目录复制到项目assets目录
cp ../.source/hanfu-test.glb assets/models/hanfu-test.glb
```

### 步骤3：配置pubspec.yaml

在 `pubspec.yaml` 中添加assets配置：

```yaml
flutter:
  uses-material-design: true
  
  # 添加assets配置
  assets:
    - assets/models/hanfu-test.glb
    # 如果后续有多个模型，可以这样配置：
    # - assets/models/
```

### 步骤4：安装3D插件

在 `pubspec.yaml` 中添加3D展示插件依赖：

```yaml
dependencies:
  flutter:
    sdk: flutter
  
  # 3D模型展示插件（选择其中一个）
  model_viewer: ^1.3.0  # 推荐：基于WebView，跨平台支持好
  # 或者
  # flutter_3d_obj: ^0.0.1  # 需要确认是否支持GLB格式
  
  cupertino_icons: ^1.0.6
```

然后运行：

```bash
flutter pub get
```

---

## 三、代码实现

### 方案1：使用model_viewer插件（推荐）

#### 3.1 创建3D查看器页面

```dart
// lib/screens/viewer/model_viewer_screen.dart
import 'package:flutter/material.dart';
import 'package:model_viewer/model_viewer.dart';

class ModelViewerScreen extends StatelessWidget {
  final String modelPath;
  final String modelName;
  
  const ModelViewerScreen({
    Key? key,
    required this.modelPath,
    required this.modelName,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(modelName),
        backgroundColor: Colors.black87,
      ),
      backgroundColor: Colors.black,
      body: ModelViewer(
        src: modelPath,
        alt: modelName,
        ar: true,
        autoRotate: true,
        cameraControls: true,
        backgroundColor: Colors.black,
      ),
    );
  }
}
```

#### 3.2 从assets加载模型

```dart
// lib/screens/viewer/model_viewer_screen.dart
import 'package:flutter/services.dart';
import 'package:path_provider/path_provider.dart';
import 'dart:io';

class ModelViewerScreen extends StatefulWidget {
  final String modelName;
  
  const ModelViewerScreen({
    Key? key,
    required this.modelName,
  }) : super(key: key);

  @override
  State<ModelViewerScreen> createState() => _ModelViewerScreenState();
}

class _ModelViewerScreenState extends State<ModelViewerScreen> {
  String? _modelPath;
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _loadModel();
  }

  Future<void> _loadModel() async {
    try {
      // 从assets加载模型到临时目录
      final ByteData data = await rootBundle.load('assets/models/hanfu-test.glb');
      final Directory tempDir = await getTemporaryDirectory();
      final File file = File('${tempDir.path}/hanfu-test.glb');
      await file.writeAsBytes(data.buffer.asUint8List());
      
      setState(() {
        _modelPath = file.path;
        _isLoading = false;
      });
    } catch (e) {
      print('模型加载失败: $e');
      setState(() {
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    if (_isLoading) {
      return Scaffold(
        appBar: AppBar(title: Text('加载中...')),
        body: Center(child: CircularProgressIndicator()),
      );
    }

    if (_modelPath == null) {
      return Scaffold(
        appBar: AppBar(title: Text('错误')),
        body: Center(child: Text('模型加载失败')),
      );
    }

    return Scaffold(
      appBar: AppBar(
        title: Text(widget.modelName),
        backgroundColor: Colors.black87,
      ),
      backgroundColor: Colors.black,
      body: ModelViewer(
        src: _modelPath!,
        alt: widget.modelName,
        ar: true,
        autoRotate: true,
        cameraControls: true,
        backgroundColor: Colors.black,
      ),
    );
  }
}
```

---

### 方案2：使用flutter_3d_obj插件（如果支持GLB）

```dart
// lib/screens/viewer/model_viewer_screen.dart
import 'package:flutter/material.dart';
// import 'package:flutter_3d_obj/flutter_3d_obj.dart';

class ModelViewerScreen extends StatelessWidget {
  final String modelName;
  
  const ModelViewerScreen({
    Key? key,
    required this.modelName,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(modelName),
        backgroundColor: Colors.black87,
      ),
      backgroundColor: Colors.black,
      body: Center(
        // 注意：flutter_3d_obj可能不支持GLB格式，需要确认
        // 如果不支持，需要将GLB转换为OBJ格式
        child: ObjViewer(
          objPath: "assets/models/hanfu-test.glb",
          scale: 0.5,
          rotate: true,
          backgroundColor: Colors.white,
        ),
      ),
    );
  }
}
```

---

## 四、模型列表页面

### 创建模型列表页面

```dart
// lib/screens/viewer/model_list_screen.dart
import 'package:flutter/material.dart';
import 'model_viewer_screen.dart';

class ModelListScreen extends StatelessWidget {
  // 模型列表数据
  final List<Map<String, String>> models = [
    {
      'id': 'hanfu-test',
      'name': '汉服测试模型',
      'dynasty': '测试',
      'type': '测试形制',
      'path': 'assets/models/hanfu-test.glb',
    },
  ];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('3D模型展示'),
      ),
      body: ListView.builder(
        itemCount: models.length,
        itemBuilder: (context, index) {
          final model = models[index];
          return Card(
            margin: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
            child: ListTile(
              leading: Icon(Icons.view_in_ar, size: 40),
              title: Text(model['name'] ?? ''),
              subtitle: Text('${model['dynasty']} - ${model['type']}'),
              trailing: Icon(Icons.arrow_forward_ios),
              onTap: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (context) => ModelViewerScreen(
                      modelName: model['name'] ?? '模型',
                    ),
                  ),
                );
              },
            ),
          );
        },
      ),
    );
  }
}
```

---

## 五、路由配置

### 在路由中添加3D查看器

```dart
// lib/utils/router.dart 或 main.dart
import 'package:go_router/go_router.dart';
import '../screens/viewer/model_viewer_screen.dart';
import '../screens/viewer/model_list_screen.dart';

final router = GoRouter(
  routes: [
    GoRoute(
      path: '/models',
      builder: (context, state) => ModelListScreen(),
    ),
    GoRoute(
      path: '/model-viewer/:modelName',
      builder: (context, state) {
        final modelName = state.pathParameters['modelName'] ?? '模型';
        return ModelViewerScreen(modelName: modelName);
      },
    ),
  ],
);
```

---

## 六、测试步骤

### 1. 验证模型文件
```bash
# 检查模型文件是否存在
ls -lh assets/models/hanfu-test.glb

# 检查文件大小（GLB文件通常几MB到几十MB）
```

### 2. 运行应用
```bash
flutter run
```

### 3. 测试功能
- [ ] 模型列表页面正常显示
- [ ] 点击模型可以进入3D查看器
- [ ] 模型可以正常加载
- [ ] 支持旋转、缩放交互
- [ ] 加载状态正常显示
- [ ] 错误处理正常（如模型文件不存在）

---

## 七、性能优化建议

### 7.1 模型加载优化
- 使用异步加载，避免阻塞UI
- 显示加载进度指示器
- 实现模型缓存机制

### 7.2 内存管理
- 模型查看器退出时释放资源
- 避免同时加载多个模型

### 7.3 低端设备适配
- 检测设备性能，低端设备降低渲染质量
- 提供"仅静态展示"选项

---

## 八、常见问题

### Q1: model_viewer插件不支持GLB格式？
**A**: model_viewer基于WebView，支持glTF/GLB格式。如果遇到问题，可以：
- 检查模型文件是否损坏
- 尝试使用在线GLB查看器验证模型
- 考虑使用其他插件如`flutter_gl`或`flutter_3d_obj`

### Q2: 模型加载很慢？
**A**: 
- 检查模型文件大小，如果过大（>10MB）考虑压缩
- 使用异步加载和进度提示
- 考虑将模型放在CDN或按需下载

### Q3: iOS上无法显示模型？
**A**: 
- 检查Info.plist中是否配置了网络权限（model_viewer需要）
- 确认模型文件已正确添加到iOS bundle

### Q4: Android上模型无法加载？
**A**:
- 检查assets目录配置是否正确
- 确认pubspec.yaml中assets路径正确
- 运行`flutter clean`后重新构建

---

## 九、后续扩展

### 9.1 添加更多模型
1. 将新模型文件放入`assets/models/`目录
2. 在`pubspec.yaml`中添加路径（或使用通配符`assets/models/`）
3. 在模型列表数据中添加新模型信息

### 9.2 模型分类
- 按朝代分类（唐/宋/明）
- 按类型分类（上装/下装/配饰）
- 支持搜索和筛选

### 9.3 模型信息展示
- 显示模型详细信息（形制、朝代、历史背景）
- 关联知识库内容
- 支持收藏功能

---

## 十、AI编码提示词

如果需要AI生成完整的3D展示功能代码，可以使用以下提示词：

```
请用Flutter生成一个3D汉服模型展示功能，要求：

1. 使用model_viewer插件
2. 模型文件：assets/models/hanfu-test.glb
3. 功能要求：
   - 模型列表页面（显示模型名称、朝代、类型）
   - 3D查看器页面（全屏沉浸式，支持旋转、缩放）
   - 从assets异步加载模型到临时目录
   - 显示加载状态和错误处理
   - 使用Provider进行状态管理

4. 代码结构：
   - models/model_info.dart（模型信息数据模型）
   - screens/viewer/model_list_screen.dart（列表页）
   - screens/viewer/model_viewer_screen.dart（查看器页）
   - services/model_service.dart（模型加载服务）

5. UI要求：
   - Material Design 3风格
   - 黑色背景（3D查看器）
   - 卡片式列表布局

请包含完整的错误处理和单元测试。
```

---

> **注意**：model_viewer插件在iOS上可能需要网络权限（因为使用WebView），如果完全离线使用，可能需要考虑其他方案如flutter_gl或原生3D引擎。

